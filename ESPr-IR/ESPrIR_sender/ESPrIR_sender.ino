// 送信データの例1
unsigned int airConOn[595] = {
3373,1611,460,1183,467,413,465,410,468,410,468,410,467,411,467,410,467,415,467,410,467,411,468,409,466,412,468,1173,468,410,469,408,469,415,467,409,468,409,468,409,468,409,469,410,468,408,469,411,467,414,468,409,468,409,469,409,468,409,468,410,469,408,468,1177,466,415,465,1177,468,1173,468,1177,467,1174,468,1176,467,1175,459,418,468,1180,466,1177,468,1174,468,1175,467,1175,468,1176,466,1176,469,1174,466,1181,468,408,468,410,469,410,467,409,469,409,469,409,467,410,468,414,466,412,466,412,466,1176,467,1175,467,412,466,410,468,1175,467,1179,469,1173,470,1174,468,410,468,410,467,1174,468,1176,468,409,466,416,468,409,466,1177,460,418,466,412,468,1172,470,410,467,411,467,1177,469,1175,468,409,468,1176,468,1174,468,410,458,1184,469,1174,467,414,478,1166,467,1175,470,408,467,413,466,1174,468,411,467,410,466,414,469,410,466,410,469,1174,460,1184,469,408,467,1174,470,1173,470,1177,469,410,468,409,468,1176,467,409,467,411,467,1174,470,1174,468,413,469,1174,469,1173,470,410,467,1175,468,1176,466,408,469,411,466,1180,468,410,467,411,468,408,468,412,467,408,453,426,467,410,460,422,468,1175,468,1174,468,1174,469,1175,466,1177,467,1173,469,1176,466,1179,461,418,468,410,460,417,467,411,468,409,466,413,467,410,466,414,460,1184,467,1174,467,1177,467,1174,469,1176,466,1176,468,1174,468,1180,468,408,468,411,466,411,467,411,467,413,466,409,467,411,467,413,468,1176,467,1175,468,1174,469,1173,469,1176,467,1174,468,1177,467,1178,468,411,467,408,469,411,467,409,467,411,467,412,467,409,468,413,468,1175,469,1175,466,1177,467,1174,467,1177,467,1173,471,1174,468,1180,467,408,468,412,466,410,468,411,466,410,469,409,459,416,471,413,467,1175,470,1173,467,1175,468,1176,460,1182,468,1177,467,1174,467,1181,467,1175,467,1175,468,409,467,412,467,411,467,1173,469,409,469,414,465,412,468,408,468,1177,467,1173,469,1176,467,411,467,1175,467,1179,469,1174,468,409,468,412,467,410,466,1175,469,1173,469,1176,459,1185,469,411,467,1174,470,1174,466,1179,466,409,459,419,459,418,467,416,458,418,468,410,467,410,467,412,466,409,469,411,467,408,467,417,466,1175,468,1177,466,1175,467,1177,467,1175,467,1175,468,1175,467,1179,459,420,466,409,469,410,467,410,460,417,468,411,467,410,470,412,467,1177,468,1173,467,1178,467,1173,468,1177,467,1174,468,1175,468,1180,466,411,468,410,466,409,470,409,467,411,469,408,466,412,468,413,466,1176,469,1174,460,1183,469,1173,469,1174,468,1175,470,1174,466,1180,469,1174,467,1174,470,409,467,413,466,409,467,413,458,417,475,408,466,412,466,409,470,1175,458,1183,460,1183,468,1173,470,1173,469,1177,468
};

// 送信データの例1
unsigned int PowerOff[595] = {
3363,1613,442,1198,468,413,466,408,468,412,468,408,466,413,443,433,445,438,468,408,467,412,443,433,445,434,442,1198,468,413,441,433,468,417,466,408,468,413,466,408,468,413,441,433,468,413,440,435,446,438,466,408,447,434,441,434,467,412,464,412,441,438,463,1179,441,442,464,1177,442,1200,445,1200,462,1178,441,1204,441,1200,442,438,441,1204,441,1204,462,1178,441,1204,443,1198,442,1198,468,1177,443,1199,441,1209,461,413,468,412,462,413,442,438,441,435,441,438,442,434,441,438,447,390,484,438,463,1177,464,1181,464,412,463,413,466,1179,462,1183,441,1204,463,1177,468,413,441,433,443,1202,463,1178,463,413,445,438,442,383,517,1179,463,416,463,412,464,1181,441,435,462,413,467,1182,463,1182,463,413,441,1199,468,1177,443,433,441,1204,463,1182,463,413,466,1179,594,1046,441,438,443,433,442,1203,442,434,466,413,463,417,466,413,442,434,468,1172,468,1177,443,438,441,1199,443,1198,467,1182,463,413,468,411,442,1200,466,408,468,412,467,1174,468,1177,442,438,466,1179,466,1175,467,409,466,1179,467,1173,447,433,467,408,467,1182,468,408,468,411,468,408,468,412,466,409,467,413,468,408,466,417,468,1173,467,1175,466,1179,466,1174,468,1177,468,1172,468,1177,468,1177,468,408,468,413,466,408,468,412,468,408,466,413,468,408,466,417,468,1173,468,1178,467,1174,491,1154,463,1177,468,1173,467,1179,466,1179,466,413,468,408,467,412,467,409,467,413,466,408,468,413,466,413,467,1175,466,1178,467,1174,493,1147,472,1175,491,1149,466,1179,466,1179,466,413,468,408,493,386,467,409,467,413,466,408,493,388,467,412,493,1149,466,1179,492,1148,468,1178,492,1149,493,1147,468,1177,468,1177,468,413,467,408,492,387,468,408,492,387,468,408,493,386,468,412,468,1177,493,1148,493,1152,467,1175,491,1149,466,1179,466,1174,493,1157,493,1147,493,1149,467,412,493,383,466,413,468,1174,466,413,468,412,492,387,493,383,493,1152,493,1147,493,1148,493,387,468,1173,493,1156,493,1149,492,387,493,383,491,388,493,383,493,1147,468,1177,468,1177,468,412,493,1148,493,1152,493,1147,493,1152,468,408,493,387,467,412,468,408,468,411,468,408,493,387,492,383,493,387,466,410,491,392,493,1148,493,1149,470,1175,493,1147,493,1152,493,1149,491,1154,491,1154,491,388,463,413,493,385,464,412,493,383,492,387,493,387,489,390,493,1149,467,1174,496,1149,491,1154,491,1149,493,1148,472,1173,493,1151,493,388,491,383,468,413,491,383,468,412,492,383,493,387,468,411,468,1177,493,1149,491,1149,496,1149,493,1148,497,1148,493,1147,468,1182,467,1175,491,1154,466,408,493,387,493,383,492,387,493,383,493,390,468,408,493,383,492,1153,493,1148,493,1151,493,1149,493,1148,468,1177,472
};

/*
  ESPrIR_sender.ino
  ESPr IR から赤外線データを送信する
  Shop: https://www.switch-science.com/
  Blog: http://mag.switch-science.com/
*/

#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>
#include <ESP8266mDNS.h>

#define IRLEDPIN 14

const char *ssid = "****";
const char *password = "****";

ESP8266WebServer server ( 80 );


void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);
  Serial.println("");

  while( WiFi.status() != WL_CONNECTED){
    delay(500);
    Serial.print(".");
  }
  Serial.println("");
  Serial.print("Connected to ");
  Serial.println(ssid);
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());

  server.on("/",handleRoot);
  server.onNotFound(handleNotFound);
  server.begin();
  Serial.println("HTTP server started");

  pinMode(IRLEDPIN,OUTPUT);
  pinMode(13,OUTPUT);
  pinMode(5,INPUT);
}

void loop() {
  server.handleClient();
}

void handleRoot() {
  char temp[1500];
  int sec = millis() / 1000;
  int min = sec / 60;
  int hr = min / 60;

  char message[20];
  String(server.arg(0)).toCharArray(message,20);

  if(server.arg(0).indexOf("Power Off") != -1){
    Serial.println("PowerOff");
    sendIRData(PowerOff,595);
  }
  else if(server.arg(0).indexOf("air-con On") != -1){
    Serial.println("air-con On");
    sendIRData(airConOn,595);
  }
  
  snprintf ( temp, 1500,

"<html>\
  <head>\
    <title>ESPr IR Demo</title>\
    <style>\
      body { background-color: #cccccc; font-family: Arial, Helvetica, Sans-Serif; Color: #000088; }\
    </style>\
  </head>\
  <body>\
    <h1>ESPr IR DEMO</h1>\
    <p>Uptime: %02d:%02d:%02d</p>\
    <p>BUTTON :%s</p>\
    <form action=\"/\" method=\"post\">\
      <input type=\"submit\" name=\"button1\" value=\"Power Off\" style=\"width:30%; height:100px\">\
      <input type=\"submit\" name=\"button2\" value=\"air-con On\" style=\"width:30%; height:100px\">\
    </form>\
  </body>\
</html>",

    hr, min % 60, sec % 60 ,message
    
  );
  server.send ( 200, "text/html", temp );
}

void handleNotFound() {

  String message = "File Not Found\n\n";
  message += "URI: ";
  message += server.uri();
  message += "\nMethod: ";
  message += ( server.method() == HTTP_GET ) ? "GET" : "POST";
  message += "\nArguments: ";
  message += server.args();
  message += "\n";

  for ( uint8_t i = 0; i < server.args(); i++ ) {
    message += " " + server.argName ( i ) + ": " + server.arg ( i ) + "\n";
  }
  server.send ( 404, "text/plain", message );

}

void sendIRData(unsigned int  *data, int dataSize)
{
  unsigned int i=0,power=HIGH;

  digitalWrite(IRLEDPIN, LOW);
  
  while(i < dataSize)
  {
    if(power == HIGH)
    {
      long startedTime = micros();
      while(micros() - startedTime < data[i])
      {
        digitalWrite(IRLEDPIN, HIGH);
        delayMicroseconds(8);
        digitalWrite(IRLEDPIN, LOW);
        delayMicroseconds(13);
      }

      power = LOW;
    }else{
      digitalWrite(IRLEDPIN, LOW);
      delayMicroseconds(data[i]);
      power = HIGH;
    }
    i++;
  }

  digitalWrite(IRLEDPIN, LOW);

}
